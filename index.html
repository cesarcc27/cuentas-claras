<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cuentas Claras v2.3 - Master Edition</title>
    
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkN1ZW50YXMgQ2xhcmFzIiwKICAic2hvcnRfbmFtZSI6ICJDdWVudGFzIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmOGZhZmMiLAogICJ0aGVtZV9jbG9yIjogIiMzYjgyZjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8yNDg5LzI0ODkwNjQucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

    <style>
        :root {
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444;
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b;
            --border: #e2e8f0; --muted: #64748b; --accent: #f59e0b;
            --input-bg: #f1f5f9;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --border: #334155; --muted: #94a3b8; --input-bg: #334155;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: 0.3s; }
        .container { max-width: 1450px; margin: 0 auto; display: grid; grid-template-columns: 1fr 340px; gap: 25px; }
        
        @media (max-width: 1150px) { .container { grid-template-columns: 1fr; } .sidebar { order: -1; } }

        .privacy-active .blur-text { filter: blur(6px); transition: 0.2s; }
        .privacy-active .blur-text:hover { filter: blur(0); }

        header {
            grid-column: 1 / -1; background: var(--card); padding: 25px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border);
        }

        .quick-entry-bar {
            grid-column: 1 / -1; background: linear-gradient(135deg, var(--primary), #1d4ed8); color: white; padding: 18px 25px;
            border-radius: 16px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        }
        .quick-entry-bar input { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 10px; }
        .quick-entry-bar input::placeholder { color: rgba(255, 255, 255, 0.75); }

        .ed-panel { background: #1e293b; color: white; padding: 20px; border-radius: 16px; display: none; margin-bottom: 10px; border: 1px solid #334155; }
        .ed-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        .ed-stat { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .ed-stat label { display: block; font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
        .ed-stat span { font-weight: bold; font-size: 1.1rem; }

        .ed-bar-bg { background: #334155; height: 14px; border-radius: 7px; margin: 15px 0; overflow: hidden; border: 1px solid #475569; }
        .ed-bar-fill { background: linear-gradient(90deg, #10b981, #34d399); height: 100%; transition: 0.6s ease-in-out; width: 0%; }

        .section-card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; background: var(--input-bg); padding: 18px; border-radius: 12px; margin-bottom: 20px; }
        
        input, select { box-sizing: border-box; width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); font-size: 0.9rem; transition: 0.2s; height: 42px; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        ::placeholder { color: var(--muted); opacity: 1; }
        input[type="checkbox"] { width: auto; height: auto; cursor: pointer; }

        button { cursor: pointer; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-weight: 600; transition: 0.2s; }
        button.primary { background: var(--primary); color: white; border: none; box-shadow: 0 2px 4px rgba(59,130,246,0.3); }
        button.success { background: var(--success); color: white; border: none; box-shadow: 0 2px 4px rgba(16,185,129,0.3); }
        button.danger { background: var(--danger); color: white; border: none; box-shadow: 0 2px 4px rgba(239,68,68,0.3); }

        table { width: 100%; border-collapse: collapse; }
        th { color: var(--muted); font-weight: 600; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; padding: 12px; border-bottom: 2px solid var(--border); }
        td { padding: 14px 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }

        #importModal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; 
            backdrop-filter: blur(4px);
        }
        .modal-content { 
            background: var(--card); padding: 30px; border-radius: 20px; width: 350px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); border: 1px solid var(--border);
        }

        .cal-day { font-size: 0.8rem; border-radius: 8px; border: 1px solid var(--border); aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: var(--input-bg); cursor: default; position: relative; }
        .has-event { background: rgba(59, 130, 246, 0.15); border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .is-today { background: var(--accent); color: white; border-color: var(--accent); transform: scale(1.1); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .switch { position: relative; display: inline-block; width: 40px; height: 22px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(18px); }
    </style>
</head>
<body id="mainBody">

<div class="container">
    <header>
        <div>
            <h1 style="margin:0; color:var(--primary); letter-spacing: -1px;">Cuentas Claras <span style="font-size: 0.8rem; color:var(--muted); font-weight: normal;">v2.3</span></h1>
            <div style="margin-top:10px; display:flex; gap:15px; align-items:center;">
                <label class="switch"><input type="checkbox" id="edToggle" onchange="toggleEDMode()"><span class="slider"></span></label>
                <span style="font-size:0.85rem; font-weight: 500;">EveryDollar Mode</span>
                <button id="privacyBtn" onclick="togglePrivacy()" style="font-size:0.75rem">üëÅÔ∏è Privacidad: OFF</button>
            </div>
        </div>
        <div style="text-align: center">
            <div style="display:flex; align-items:center; gap:12px">
                <button onclick="changeMonth(-1)">‚óÄ</button>
                <h2 id="currentMonthLabel" style="margin:0; min-width:180px; font-weight: 800; text-transform: capitalize;"></h2>
                <button onclick="changeMonth(1)">‚ñ∂</button>
            </div>
        </div>
        <div style="display:flex; gap:10px">
            <button onclick="toggleTheme()" style="background: var(--input-bg);">üåì</button>
            <button onclick="openImportModal()" class="primary">üìã Clonar Anterior</button>
            <button onclick="exportData()" style="background: var(--input-bg);">üíæ Backup</button>
        </div>
    </header>

    <div class="quick-entry-bar">
        <strong style="font-size: 1.1rem">‚ö° Quick Entry:</strong>
        <input type="text" id="qeDesc" placeholder="¬øEn qu√© gastaste hoy?" style="flex:2">
        <input type="number" id="qeAmount" placeholder="Monto $" style="flex:1">
        <button class="success" onclick="addQuickExpense()" style="background: white; color: var(--success); padding: 10px 25px;">+ REGISTRAR</button>
    </div>

    <div class="main-content">
        <div id="edPanel" class="ed-panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; font-size: 1.1rem;">Estado del Presupuesto</span>
                <span id="edStatus" class="blur-text" style="background: var(--success); padding: 4px 12px; border-radius: 20px; font-size: 0.9rem;">$0 por asignar</span>
            </div>
            <div class="ed-bar-bg"><div id="edBar" class="ed-bar-fill"></div></div>
            <div class="ed-grid">
                <div class="ed-stat"><label>Ingresos</label><span id="edInc" class="blur-text">$0</span></div>
                <div class="ed-stat"><label>Gastos</label><span id="edExp" class="blur-text">$0</span></div>
                <div class="ed-stat"><label>Disponible</label><span id="edNet" class="blur-text">$0</span></div>
            </div>
        </div>

        <section class="section-card">
            <h3 style="margin-top:0">üõí Gastos Diarios</h3>
            <table>
                <thead><tr><th width="80">D√≠a</th><th>Concepto</th><th>Monto</th><th width="50"></th></tr></thead>
                <tbody id="dailyTableBody"></tbody>
            </table>
        </section>

        <section class="section-card">
            <h3>üí∞ Ingresos</h3>
            <div class="grid-inputs">
                <input type="text" id="incDesc" placeholder="Descripci√≥n">
                <input type="number" id="incAmount" placeholder="Monto">
                <button class="success" onclick="addItem('income')">+ Agregar</button>
            </div>
            <table id="incTable"><thead><tr><th>Descripci√≥n</th><th>Monto</th><th></th></tr></thead><tbody id="incTableBody"></tbody></table>
        </section>

        <section class="section-card">
            <h3>üì∫ Suscripciones / Fijos</h3>
            <div class="grid-inputs">
                <input type="text" id="subName" placeholder="Servicio">
                <input type="number" id="subAmount" placeholder="Monto">
                <input type="number" id="subDay" placeholder="D√≠a (1-31)">
                <button class="primary" onclick="addItem('subs')">+ Agregar</button>
            </div>
            <table><thead><tr><th>D√≠a</th><th>Servicio</th><th>Monto</th><th></th></tr></thead><tbody id="subTableBody"></tbody></table>
        </section>

        <section class="section-card">
            <h3>üí≥ Tarjetas</h3>
            <div class="grid-inputs">
                <input type="text" id="ccName" placeholder="Nombre">
                <input type="number" id="ccLimit" placeholder="L√≠mite">
                <input type="number" id="ccBalance" placeholder="Saldo">
                <input type="number" id="ccPlan" placeholder="Pago Plan">
                <button class="primary" onclick="addItem('cards')">+ Agregar</button>
            </div>
            <table id="ccTableBody"></table>
        </section>
    </div>

    <aside class="sidebar">
        <div class="section-card">
            <h4 style="margin:0 0 15px 0; text-align:center">üìÖ Pagos</h4>
            <div id="calendarGrid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px;"></div>
        </div>
    </aside>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsgZXZlbnQucmVzcG9uZFdpdGgoZmV0Y2goZXZlbnQucmVxdWVzdCkpOyB9KTs=');
        });
    }

    let currentDate = new Date();
    let appData = JSON.parse(localStorage.getItem('cuentasClarasData')) || {};
    let edMode = localStorage.getItem('edMode') === 'true';
    let privacyMode = false;

    function getMonthKey(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; }
    function saveData() { localStorage.setItem('cuentasClarasData', JSON.stringify(appData)); render(); }
    function toggleEDMode() { edMode = document.getElementById('edToggle').checked; localStorage.setItem('edMode', edMode); render(); }
    function toggleTheme() {
        const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', theme);
    }
    function togglePrivacy() {
        privacyMode = !privacyMode;
        document.getElementById('mainBody').classList.toggle('privacy-active', privacyMode);
        document.getElementById('privacyBtn').innerText = privacyMode ? "üëÅÔ∏è Privacidad: ON" : "üëÅÔ∏è Privacidad: OFF";
    }

    function changeMonth(step) {
        currentDate.setMonth(currentDate.getMonth() + step);
        render();
    }

    function addItem(type) {
        const key = getMonthKey(currentDate);
        if(!appData[key]) appData[key] = { income:[], expenses:[], cards:[], daily:[], subs:[] };
        
        let item = {};
        if(type === 'income') {
            item = { desc: document.getElementById('incDesc').value, amount: parseFloat(document.getElementById('incAmount').value) };
        } else if(type === 'subs') {
            item = { name: document.getElementById('subName').value, amount: parseFloat(document.getElementById('subAmount').value), day: parseInt(document.getElementById('subDay').value) };
        } else if(type === 'cards') {
            item = { name: document.getElementById('ccName').value, limit: parseFloat(document.getElementById('ccLimit').value), balance: parseFloat(document.getElementById('ccBalance').value), plan: parseFloat(document.getElementById('ccPlan').value) };
        }
        
        appData[key][type].push(item);
        saveData();
    }

    function addQuickExpense() {
        const key = getMonthKey(currentDate);
        if(!appData[key]) appData[key] = { income:[], expenses:[], cards:[], daily:[], subs:[] };
        appData[key].daily.push({ 
            date: new Date().toISOString().split('T')[0], 
            desc: document.getElementById('qeDesc').value, 
            amount: parseFloat(document.getElementById('qeAmount').value) 
        });
        document.getElementById('qeDesc').value = '';
        document.getElementById('qeAmount').value = '';
        saveData();
    }

    function deleteItem(type, index) {
        const key = getMonthKey(currentDate);
        appData[key][type].splice(index, 1);
        saveData();
    }

    function render() {
        const key = getMonthKey(currentDate);
        const d = appData[key] || { income:[], expenses:[], cards:[], daily:[], subs:[] };
        
        document.getElementById('currentMonthLabel').innerText = currentDate.toLocaleString('es', {month:'long', year:'numeric'});
        document.getElementById('edPanel').style.display = edMode ? 'block' : 'none';

        // Tablas
        document.getElementById('dailyTableBody').innerHTML = d.daily.map((x,i)=>`<tr><td>${x.date.split('-')[2]}</td><td>${x.desc}</td><td class="blur-text">$${x.amount}</td><td><button onclick="deleteItem('daily',${i})">üóë</button></td></tr>`).join('');
        document.getElementById('incTableBody').innerHTML = d.income.map((x,i)=>`<tr><td>${x.desc}</td><td class="blur-text">$${x.amount}</td><td><button onclick="deleteItem('income',${i})">üóë</button></td></tr>`).join('');
        document.getElementById('subTableBody').innerHTML = d.subs.map((x,i)=>`<tr><td>${x.day}</td><td>${x.name}</td><td class="blur-text">$${x.amount}</td><td><button onclick="deleteItem('subs',${i})">üóë</button></td></tr>`).join('');

        // Resumen EveryDollar
        let tInc = d.income.reduce((s,x)=>s+x.amount,0);
        let tExp = d.daily.reduce((s,x)=>s+x.amount,0) + d.subs.reduce((s,x)=>s+x.amount,0) + d.cards.reduce((s,x)=>s+x.plan,0);
        
        document.getElementById('edInc').innerText = `$${tInc}`;
        document.getElementById('edExp').innerText = `$${tExp}`;
        document.getElementById('edNet').innerText = `$${tInc - tExp}`;
        document.getElementById('edBar').style.width = tInc > 0 ? (tExp/tInc*100)+'%' : '0%';
        document.getElementById('edStatus').innerText = `$${tInc - tExp} por asignar`;

        // Calendario
        let daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate();
        let calHtml = '';
        for(let i=1; i<=daysInMonth; i++) {
            let hasPay = d.subs.some(s => s.day === i);
            calHtml += `<div class="cal-day ${hasPay?'has-event':''}">${i}</div>`;
        }
        document.getElementById('calendarGrid').innerHTML = calHtml;
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(appData)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `backup_cuentas_${getMonthKey(new Date())}.json`;
        a.click();
    }

    render();
</script>
</body>
</html>
