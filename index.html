<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cuentas Claras v2.3 - Master Edition</title>
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkN1ZW50YXMgQ2xhcmFzIiwKICAic2hvcnRfbmFtZSI6ICJDdWVudGFzIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmOGZhZmMiLAogICJ0aGVtZV9jbG9yIjogIiMzYjgyZjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8yNDg5LzI0ODkwNjQucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

    <style>
        :root {
            --primary: #3b82f6; --success: #10b981; --danger: #ef4444;
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b;
            --border: #e2e8f0; --muted: #64748b; --accent: #f59e0b;
            --input-bg: #f1f5f9;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --border: #334155; --muted: #94a3b8; --input-bg: #334155;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; transition: 0.3s; padding-bottom: 90px !important; }
        .container { max-width: 1450px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

        /* --- NUEVOS ESTILOS NAVEGACI√ìN --- */
        .tab-content { display: none; width: 100%; flex-direction: column; gap: 20px; }
        .tab-content.active { display: flex; }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: var(--card); display: flex; justify-content: space-around;
            align-items: center; border-top: 1px solid var(--border); z-index: 2000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; 
            color: var(--muted); font-size: 0.75rem; cursor: pointer; flex: 1; padding: 10px 0;
        }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item span { font-size: 1.4rem; margin-bottom: 2px; }

        .fab {
            position: fixed; bottom: 85px; left: 20px; width: 56px; height: 56px;
            background: var(--primary); color: white; border-radius: 50%;
            border: none; font-size: 24px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            z-index: 1999; display: flex; align-items: center; justify-content: center;
        }

        /* --- ESTILOS ORIGINALES REUTILIZADOS --- */
        .privacy-active .blur-text { filter: blur(6px); transition: 0.2s; }
        .privacy-active .blur-text:hover { filter: blur(0); }

        header {
            background: var(--card); padding: 25px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border);
        }

        .quick-entry-bar {
            background: linear-gradient(135deg, var(--primary), #1d4ed8); color: white; padding: 18px 25px;
            border-radius: 16px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
        }
        .quick-entry-bar input { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 10px; }
        .quick-entry-bar input::placeholder { color: rgba(255, 255, 255, 0.75); }

        .ed-panel { background: #1e293b; color: white; padding: 20px; border-radius: 16px; display: none; border: 1px solid #334155; }
        .ed-grid { display: flex; justify-content: space-between; gap: 5px; width: 100%; }
        .ed-stat { flex: 1; text-align: center; padding: 10px 5px; }
        .ed-stat span { display: block; font-size: clamp(0.8rem, 3vw, 1.1rem); }
        .ed-stat label { display: block; font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
        .ed-bar-bg { background: #334155; height: 14px; border-radius: 7px; margin: 15px 0; overflow: hidden; border: 1px solid #475569; }
        .ed-bar-fill { background: linear-gradient(90deg, #10b981, #34d399); height: 100%; transition: 0.6s ease-in-out; width: 0%; }

        .section-card { background: var(--card); padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); width: 100%; box-sizing: border-box; }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; background: var(--input-bg); padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        
        table { width: 100%; border-collapse: collapse; display: block; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        th { color: var(--muted); font-weight: 600; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; padding: 12px; border-bottom: 2px solid var(--border); text-align: left; }
        td { padding: 14px 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; text-align: left; }

        input, select { box-sizing: border-box; width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); font-size: 0.9rem; transition: 0.2s; height: 42px; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        button { cursor: pointer; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-weight: 600; transition: 0.2s; }
        button.primary { background: var(--primary); color: white; border: none; }
        button.success { background: var(--success); color: white; border: none; }
        button.danger { background: var(--danger); color: white; border: none; }

        .cal-day { font-size: 0.8rem; border-radius: 8px; border: 1px solid var(--border); aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: var(--input-bg); position: relative; }
        .has-event { background: rgba(59, 130, 246, 0.15); border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .is-today { background: var(--accent); color: white; border-color: var(--accent); transform: scale(1.1); }

        .switch { position: relative; display: inline-block; width: 40px; height: 22px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Estilos Chart */
        .chart-row span:first-child { font-size: 0.85rem !important; width: 85px !important; font-weight: 500; }
        .chart-row span:last-child { font-size: 0.8rem !important; color: var(--primary); }
        .chart-bar-bg { height: 10px !important; background: #e2e8f0; border-radius: 6px; overflow: hidden; flex: 1; }
        .chart-bar-fill { background: var(--accent) !important; transition: width 0.8s ease-in-out; height: 100%; }

        #importModal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal-content { background: var(--card); padding: 30px; border-radius: 20px; width: 350px; border: 1px solid var(--border); }
    </style>
</head>
<body id="mainBody">

<div class="container">
    <header>
        <div>
            <h1 style="margin:0; color:var(--primary); letter-spacing: -1px;">Cuentas Claras <span style="font-size: 0.8rem; color:var(--muted); font-weight: normal;">v2.3</span></h1>
            <div style="margin-top:10px; display:flex; gap:15px; align-items:center;">
                <label class="switch"><input type="checkbox" id="edToggle" onchange="toggleEDMode()"><span class="slider"></span></label>
                <span style="font-size:0.85rem; font-weight: 500;">EveryDollar Mode</span>
                <button id="privacyBtn" onclick="togglePrivacy()" style="font-size:0.75rem">üëÅÔ∏è Privacidad: OFF</button>
            </div>
        </div>
        <div style="text-align: center">
            <div style="display:flex; align-items:center; gap:12px">
                <button onclick="changeMonth(-1)">‚óÄ</button>
                <h2 id="currentMonthLabel" style="margin:0; min-width:180px; font-weight: 800; text-transform: capitalize;"></h2>
                <button onclick="changeMonth(1)">‚ñ∂</button>
            </div>
            <button onclick="resetMonth()" class="danger" style="margin-top:10px; padding: 4px 12px; font-size: 0.65rem; opacity: 0.8;">BORRAR DATOS DEL MES</button>
        </div>
        <div style="display:flex; gap:10px">
            <button onclick="toggleTheme()" style="background: var(--input-bg);">üåì</button>
            <button onclick="openImportModal()" class="primary">üìã Clonar Anterior</button>
            <button onclick="exportData()" style="background: var(--input-bg);">üíæ Backup</button>
        </div>
    </header>

    <div id="tab-gastos" class="tab-content active">
        <div class="quick-entry-bar" id="quickEntrySection">
            <strong style="font-size: 1.1rem">‚ö° Quick Entry:</strong>
            <input type="text" id="qeDesc" placeholder="¬øEn qu√© gastaste hoy?" style="flex:2">
            <input type="number" id="qeAmount" placeholder="Monto $" style="flex:1">
            <button class="success" onclick="addQuickExpense()" style="background: white; color: var(--success); padding: 10px 25px;">+ REGISTRAR</button>
        </div>

        <section class="section-card" style="border-left: 5px solid var(--accent)">
            <h3 style="margin-top:0">üõí Gastos Diarios</h3>
            <table>
                <thead><tr><th width="80">D√≠a</th><th>Concepto</th><th>Categor√≠a</th><th>Monto</th><th width="50"></th></tr></thead>
                <tbody id="dailyTableBody"></tbody>
            </table>
        </section>

        <section class="section-card">
            <h3>üí∞ Ingresos del Mes</h3>
            <div class="grid-inputs">
                <input type="date" id="incDate">
                <input type="text" id="incDesc" placeholder="Descripci√≥n">
                <input type="number" id="incAmount" placeholder="Monto">
                <button class="success" onclick="addIncome()">+ Agregar</button>
            </div>
            <table><thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Monto</th><th></th></tr></thead><tbody id="incTableBody"></tbody></table>
        </section>

        <section class="section-card">
            <h3>üì∫ Suscripciones y Recurrentes</h3>
            <div class="grid-inputs">
                <input type="text" id="subName" placeholder="Servicio">
                <input type="number" id="subAmount" placeholder="Monto">
                <input type="number" id="subDay" placeholder="D√≠a (1-31)">
                <button class="primary" onclick="addSubscription()">+ Agregar</button>
            </div>
            <table><thead><tr><th width="50">Pago</th><th>D√≠a</th><th>Servicio</th><th>Monto</th><th></th></tr></thead><tbody id="subTableBody"></tbody></table>
        </section>

        <section class="section-card">
            <h3>üí∏ Facturas y Gastos Fijos</h3>
            <div class="grid-inputs">
                <input type="date" id="expDate">
                <input type="text" id="expDesc" placeholder="Concepto">
                <select id="expCat">
                    <option value="Vivienda">üè† Vivienda</option>
                    <option value="Servicios">‚ö° Servicios</option>
                    <option value="Comida">üçî Comida</option>
                    <option value="Ocio">üé¨ Ocio</option>
                </select>
                <input type="number" id="expAmount" placeholder="Monto">
                <button class="danger" onclick="addExpense()">+ Agregar</button>
            </div>
            <table><thead><tr><th width="50">Pago</th><th>Fecha</th><th>Concepto</th><th>Categor√≠a</th><th>Monto</th><th></th></tr></thead><tbody id="expTableBody"></tbody></table>
        </section>
    </div>

    <div id="tab-plan" class="tab-content">
        <section class="section-card">
            <h4 style="margin:0 0 15px 0; text-align:center">üìÖ Calendario de Pagos</h4>
            <div id="calendarGrid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px;"></div>
        </section>

        <section class="section-card">
            <h3>üí≥ Tarjetas de Cr√©dito</h3>
            <div class="grid-inputs">
                <input type="text" id="ccName" placeholder="Nombre Tarjeta">
                <input type="number" id="ccBalance" placeholder="Saldo Actual">
                <input type="number" id="ccAPR" placeholder="APR %">
                <input type="number" id="ccPlan" placeholder="Plan de Pago">
                <input type="date" id="ccCorte" placeholder="Corte">
                <input type="date" id="ccVence" placeholder="Vencimiento">
                <input type="number" id="ccLimit" placeholder="L√≠mite Total">
                <input type="number" id="ccPromo" placeholder="Monto 0% Int.">
                <input type="date" id="ccPromoDate" placeholder="Fin Promo 0%">
                <button class="primary" onclick="addCard()" style="grid-column: 1 / -1;">+ Agregar Tarjeta</button>
            </div>
            <table>
                <thead>
                    <tr><th>OK</th><th>Tarjeta</th><th>Saldo / L√≠mite</th><th>Pago Plan</th><th>Vencimiento</th><th>Promo</th><th></th></tr>
                </thead>
                <tbody id="ccTableBody"></tbody>
            </table>
        </section>

        <section class="section-card">
            <h4 style="margin:0 0 15px 0">‚ùÑÔ∏è Bola de Nieve</h4>
            <div id="snowballList" style="font-size:0.85rem"></div>
        </section>
    </div>

    <div id="tab-resumen" class="tab-content">
        <div id="edPanel" class="ed-panel" style="display: block;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold; font-size: 1.1rem;">Estado del Presupuesto</span>
                <span id="edStatus" class="blur-text" style="background: var(--success); padding: 4px 12px; border-radius: 20px; font-size: 0.9rem;">$0 por asignar</span>
            </div>
            <div class="ed-bar-bg"><div id="edBar" class="ed-bar-fill"></div></div>
            <div class="ed-grid">
                <div class="ed-stat"><label>Ingresos</label><span id="edInc" class="blur-text">$0</span></div>
                <div class="ed-stat"><label>Gastos</label><span id="edExp" class="blur-text">$0</span></div>
                <div class="ed-stat"><label>Disponible</label><span id="edNet" class="blur-text">$0</span></div>
            </div>
        </div>

        <section class="section-card">
            <h4 style="margin:0 0 15px 0">üìä Distribuci√≥n</h4>
            <div id="categoryChart"></div>
        </section>
    </div>
</div>

<button class="fab" onclick="goToQuickEntry()">‚ö°</button>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab(event, 'gastos')"><span>üè†</span>Gastos</div>
    <div class="nav-item" onclick="switchTab(event, 'plan')"><span>üìÖ</span>Pagos</div>
    <div class="nav-item" onclick="switchTab(event, 'resumen')"><span>üìä</span>Resumen</div>
</nav>

<div id="importModal">
    <div class="modal-content">
        <h3>Clonar Mes Anterior</h3>
        <p style="font-size: 0.8rem; color: var(--muted); margin-bottom: 15px;">Selecciona qu√© secciones:</p>
        <label><input type="checkbox" id="impInc" checked> Ingresos</label>
        <label><input type="checkbox" id="impSub" checked> Suscripciones</label>
        <label><input type="checkbox" id="impExp" checked> Gastos Fijos</label>
        <label><input type="checkbox" id="impCC" checked> Tarjetas de Cr√©dito</label>
        <div style="display:flex; gap:10px; margin-top: 20px;">
            <button class="primary" onclick="processImport()" style="flex:1">Importar</button>
            <button onclick="closeImportModal()" style="flex:1">Cancelar</button>
        </div>
    </div>
</div>

<script>
    // --- L√ìGICA DE NAVEGACI√ìN ---
    function switchTab(event, tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        window.scrollTo(0,0);
    }

    function goToQuickEntry() {
        // Asegura que estamos en la pesta√±a de gastos para ver el input
        const navGastos = document.querySelector('.nav-item:first-child');
        const eventMock = { currentTarget: navGastos };
        switchTab(eventMock, 'gastos');
        document.getElementById('qeDesc').focus();
        document.getElementById('quickEntrySection').scrollIntoView({behavior: "smooth"});
    }

    // --- TU L√ìGICA ORIGINAL INTACTA ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsgZXZlbnQucmVzcG9uZFdpdGgoZmV0Y2goZXZlbnQucmVxdWVzdCkpOyB9KTs=')
            .then(reg => console.log('PWA Lista')).catch(err => console.log('Error PWA', err));
        });
    }

    let currentDate = new Date();
    let appData = JSON.parse(localStorage.getItem('cuentasClarasData')) || {};
    let edMode = localStorage.getItem('edMode') === 'true';
    let privacyMode = false;

    function getMonthKey(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; }
    function saveData() { localStorage.setItem('cuentasClarasData', JSON.stringify(appData)); render(); }

    function togglePrivacy() {
        privacyMode = !privacyMode;
        document.getElementById('mainBody').classList.toggle('privacy-active', privacyMode);
        document.getElementById('privacyBtn').innerText = privacyMode ? "üëÅÔ∏è Privacidad: ON" : "üëÅÔ∏è Privacidad: OFF";
    }

    function toggleEDMode() { edMode = document.getElementById('edToggle').checked; localStorage.setItem('edMode', edMode); render(); }

    function render() {
        const key = getMonthKey(currentDate);
        if (!appData[key]) appData[key] = { income:[], expenses:[], cards:[], daily:[], subs:[] };
        const d = appData[key];

        document.getElementById('edToggle').checked = edMode;
        document.getElementById('edPanel').style.visibility = edMode ? 'visible' : 'hidden';
        document.getElementById('edPanel').style.opacity = edMode ? '1' : '0';
        document.getElementById('currentMonthLabel').innerText = currentDate.toLocaleString('es', {month:'long', year:'numeric'});

        let tInc = d.income.reduce((s,x)=>s+parseFloat(x.amount||0),0);
        let tSub = (d.subs||[]).reduce((s,x)=>s+parseFloat(x.amount||0),0);
        let tExp = d.expenses.reduce((s,x)=>s+parseFloat(x.amount||0),0) + tSub;
        let tDaily = (d.daily||[]).reduce((s,x)=>s+parseFloat(x.amount||0),0);
        let tCC = d.cards.reduce((s,x)=>s+parseFloat(x.plan||0),0);

        document.getElementById('dailyTableBody').innerHTML = (d.daily||[]).map((x,i)=>`<tr><td>${x.date.split('-')[2]}</td><td class="editable" onclick="editItem('${key}','daily',${i},'desc')">${x.desc}</td><td><select onchange="updateDailyCat(${i},this.value)"><option value="Otros" ${x.cat==='Otros'?'selected':''}>Otros</option><option value="Comida" ${x.cat==='Comida'?'selected':''}>Comida</option></select></td><td class="blur-text"><strong>$${x.amount}</strong></td><td><button onclick="deleteItem('daily',${i})">üóë</button></td></tr>`).join('');
        document.getElementById('incTableBody').innerHTML = d.income.map((x,i)=>`<tr><td>${x.date}</td><td class="editable" onclick="editItem('${key}','income',${i},'desc')">${x.desc}</td><td class="blur-text"><strong>$${x.amount}</strong></td><td><button onclick="deleteItem('income',${i})">üóë</button></td></tr>`).join('');
        document.getElementById('subTableBody').innerHTML = (d.subs||[]).map((x,i)=>`<tr class="${x.paid?'paid-row':''}"><td><input type="checkbox" ${x.paid?'checked':''} onchange="togglePaid('subs',${i})"></td><td>${x.day}</td><td>${x.name}</td><td class="blur-text"><strong>$${x.amount}</strong></td><td><button onclick="deleteItem('subs',${i})">üóë</button></td></tr>`).join('');
        document.getElementById('expTableBody').innerHTML = d.expenses.map((x,i)=>`<tr class="${x.paid?'paid-row':''}"><td><input type="checkbox" ${x.paid?'checked':''} onchange="togglePaid('expenses',${i})"></td><td>${x.date}</td><td>${x.desc}</td><td>${x.cat}</td><td class="blur-text"><strong>$${x.amount}</strong></td><td><button onclick="deleteItem('expenses',${i})">üóë</button></td></tr>`).join('');
        document.getElementById('ccTableBody').innerHTML = d.cards.map((x,i)=>{
            const vDate = x.vence ? x.vence.split('-').reverse().join('/') : '-';
            return `<tr class="${x.paid?'paid-row':''}"><td><input type="checkbox" ${x.paid?'checked':''} onchange="togglePaid('cards',${i})"></td><td><strong>${x.name}</strong></td><td class="blur-text">$${x.balance} / $${x.limit}</td><td class="blur-text">$${x.plan}</td><td>${vDate}</td><td class="blur-text">${x.promo > 0 ? '$'+x.promo : '-'}</td><td><button onclick="deleteItem('cards',${i})">üóë</button></td></tr>`;
        }).join('');

        const net = tInc - tExp - tDaily - tCC;
        document.getElementById('edInc').innerText = `$${tInc.toFixed(0)}`;
        document.getElementById('edExp').innerText = `$${(tExp+tDaily+tCC).toFixed(0)}`;
        document.getElementById('edNet').innerText = `$${net.toFixed(0)}`;
        
        updateEveryDollar(tInc, tExp + tDaily + tCC);
        renderCalendar(d);
        updateSnowball(d.cards);
        updateChart(d);
    }

    function renderCalendar(data) {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = ['D','L','M','M','J','V','S'].map(d=>`<div style="font-size:0.6rem; color:var(--muted); font-weight:bold">${d}</div>`).join('');
        const year = currentDate.getFullYear(); const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
        const events = {};
        data.expenses.forEach(e => { const d = new Date(e.date + 'T12:00:00').getDate(); if(!events[d]) events[d] = []; events[d].push(`üí∏ ${e.desc}: $${e.amount}`); });
        data.cards.forEach(c => { if(c.vence) { const d = new Date(c.vence + 'T12:00:00').getDate(); if(!events[d]) events[d] = []; events[d].push(`üí≥ ${c.name}: $${c.plan}`); } });
        (data.subs||[]).forEach(s => { const d = parseInt(s.day); if(!events[d]) events[d] = []; events[d].push(`üì∫ ${s.name}: $${s.amount}`); });
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div></div>`;
        for (let d = 1; d <= daysInMonth; d++) {
            const hasE = events[d] ? 'has-event' : '';
            const isT = (d === new Date().getDate() && month === new Date().getMonth()) ? 'is-today' : '';
            grid.innerHTML += `<div class="cal-day ${hasE} ${isT}" data-tooltip="${events[d] ? events[d].join('\n') : ''}">${d}</div>`;
        }
    }

    function addCard() { 
        appData[getMonthKey(currentDate)].cards.push({ 
            name: document.getElementById('ccName').value, balance: document.getElementById('ccBalance').value, 
            apr: document.getElementById('ccAPR').value, plan: document.getElementById('ccPlan').value, 
            corte: document.getElementById('ccCorte').value, vence: document.getElementById('ccVence').value, 
            limit: document.getElementById('ccLimit').value, promo: document.getElementById('ccPromo').value, 
            promoDate: document.getElementById('ccPromoDate').value, paid: false 
        }); saveData();
    }

    function addQuickExpense() {
        const key = getMonthKey(currentDate);
        const desc = document.getElementById('qeDesc').value;
        const amount = document.getElementById('qeAmount').value;
        if(desc && amount) {
            if(!appData[key].daily) appData[key].daily = [];
            appData[key].daily.push({ date: new Date().toISOString().split('T')[0], desc, amount: parseFloat(amount), cat:'Otros' });
            document.getElementById('qeDesc').value = ''; document.getElementById('qeAmount').value = '';
            saveData();
        }
    }

    function updateChart(d) {
        const cats = {};
        [...d.expenses, ...(d.daily||[]), ...(d.subs||[]).map(s=>({...s, cat:'Servicios'}))].forEach(e => cats[e.cat||'Otros'] = (cats[e.cat||'Otros']||0) + parseFloat(e.amount));
        const max = Math.max(...Object.values(cats), 1);
        document.getElementById('categoryChart').innerHTML = Object.entries(cats).map(([n,v])=>`
            <div class="chart-row" style="display:flex; align-items:center; margin-bottom:8px; gap:10px;">
                <span>${n}</span>
                <div class="chart-bar-bg"><div class="chart-bar-fill" style="width:${(v/max)*100}%"></div></div>
                <span>$${v.toFixed(0)}</span>
            </div>`).join('');
    }

    function updateSnowball(cards) {
        let s = [...cards].filter(c=>c.balance>0).sort((a,b)=>a.balance-b.balance);
        document.getElementById('snowballList').innerHTML = s.map(c=>`<div style="margin-bottom:5px; border-bottom:1px solid var(--border); padding-bottom:5px;">${c.name}: <strong class="blur-text">$${c.balance}</strong></div>`).join('') || 'Sin deudas activas';
    }

    function updateEveryDollar(total, assigned) {
        let pct = total > 0 ? (assigned / total) * 100 : 0;
        document.getElementById('edBar').style.width = Math.min(pct, 100) + '%';
        let diff = total - assigned;
        document.getElementById('edStatus').innerText = diff === 0 ? "¬°Presupuesto Perfecto!" : `$${diff.toFixed(2)} por asignar`;
    }

    function addIncome() { appData[getMonthKey(currentDate)].income.push({ date: document.getElementById('incDate').value, desc: document.getElementById('incDesc').value, amount: document.getElementById('incAmount').value }); saveData(); }
    function addSubscription() { appData[getMonthKey(currentDate)].subs.push({ name: document.getElementById('subName').value, amount: document.getElementById('subAmount').value, day: document.getElementById('subDay').value, paid: false }); saveData(); }
    function addExpense() { appData[getMonthKey(currentDate)].expenses.push({ date: document.getElementById('expDate').value, desc: document.getElementById('expDesc').value, cat: document.getElementById('expCat').value, amount: document.getElementById('expAmount').value, paid: false }); saveData(); }
    function togglePaid(type, i) { appData[getMonthKey(currentDate)][type][i].paid = !appData[getMonthKey(currentDate)][type][i].paid; saveData(); }
    function deleteItem(type, i) { if(confirm("¬øEliminar registro?")) { appData[getMonthKey(currentDate)][type].splice(i, 1); saveData(); } }
    function editItem(mKey, type, index, field) { let v = prompt("Nuevo valor:", appData[mKey][type][index][field]); if(v) { appData[mKey][type][index][field] = v; saveData(); } }
    function resetMonth() { if(confirm("¬øBorrar todos los datos de este mes?")) { appData[getMonthKey(currentDate)] = { income:[], expenses:[], cards:[], daily:[], subs:[] }; saveData(); } }
    function changeMonth(o) { currentDate.setMonth(currentDate.getMonth()+o); render(); }
    function toggleTheme() { 
        let t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', t);
    }
    function openImportModal() { document.getElementById('importModal').style.display = 'flex'; }
    function closeImportModal() { document.getElementById('importModal').style.display = 'none'; }
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "CuentasClaras_Backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function processImport() {
        const prevDate = new Date(currentDate);
        prevDate.setMonth(prevDate.getMonth() - 1);
        const prevKey = getMonthKey(prevDate);
        const currKey = getMonthKey(currentDate);

        if (appData[prevKey]) {
            if (document.getElementById('impInc').checked) appData[currKey].income = [...appData[prevKey].income];
            if (document.getElementById('impSub').checked) appData[currKey].subs = [...appData[prevKey].subs];
            if (document.getElementById('impExp').checked) appData[currKey].expenses = [...appData[prevKey].expenses];
            if (document.getElementById('impCC').checked) appData[currKey].cards = [...appData[prevKey].cards.map(c => ({...c, paid: false}))];
            saveData();
            closeImportModal();
            alert("Datos clonados con √©xito");
        } else {
            alert("No hay datos del mes anterior");
        }
    }

    window.onload = render;
</script>
</body>
</html>
